# Как исправить eMMC в Windows

## Что нужно

1. **USB адаптер для eMMC** (eMMC to USB reader)
2. **Программа для работы с Linux файловой системой в Windows**

## Шаг 1: Подключить eMMC к Windows

1. Вставь eMMC в USB адаптер
2. Подключи к компьютеру
3. Windows увидит диск, но не сможет его прочитать (это нормально - это Linux файловая система)

## Шаг 2: Установить программу для чтения Linux дисков

**Вариант 1: Linux Reader (бесплатно, только чтение)**
- Скачай: https://www.diskinternals.com/linux-reader/
- Установи
- Откроет Linux диски как обычные папки
- Можешь копировать файлы, но не редактировать напрямую

**Вариант 2: Ext2Fsd (бесплатно, чтение и запись)**
- Скачай: https://sourceforge.net/projects/ext2fsd/
- Установи
- Позволяет редактировать файлы напрямую
- **ОСТОРОЖНО**: Может повредить диск при неправильном использовании

**Вариант 3: Paragon ExtFS (платно, но надежно)**
- Пробная версия на 10 дней
- Скачай: https://www.paragon-software.com/home/extfs-windows/

## Шаг 3: Найти и исправить проблемные файлы

### Файл 1: /etc/sysctl.conf (КРИТИЧНО!)

**Что делать:**
1. Открой Linux Reader или Ext2Fsd
2. Найди диск с eMMC
3. Перейди в `/etc/sysctl.conf`
4. **СНАЧАЛА СДЕЛАЙ РЕЗЕРВНУЮ КОПИЮ!** Скопируй файл на Windows как `sysctl.conf.backup`
5. Открой оригинал в блокноте
6. **Найди и удали ВСЕ эти строки (или закомментируй добавив # в начале):**
   ```
   # Оптимизация для аудио пайплайна
   net.core.rmem_max = 16777216
   net.core.wmem_max = 16777216
   net.ipv4.tcp_rmem = 4096 87380 16777216
   net.ipv4.tcp_wmem = 4096 65536 16777216
   net.core.netdev_max_backlog = 5000
   net.core.rmem_default = 262144
   net.core.wmem_default = 262144
   
   # Оптимизация для реального времени
   kernel.sched_rt_runtime_us = 950000
   kernel.sched_rt_period_us = 1000000
   kernel.sched_migration_cost_ns = 5000000
   
   vm.swappiness=1
   vm.dirty_ratio=10
   vm.dirty_background_ratio=5
   ```
7. **ВАЖНО:** Удали ВСЕ пустые строки в конце файла (если они есть)
8. Сохрани файл
9. Скопируй обратно на eMMC (замени оригинал)

**Если файл поврежден или не можешь его исправить:**
- Попробуй найти `/etc/sysctl.conf.backup` (если есть)
- Или создай новый минимальный файл с базовыми настройками

### Файл 2: /etc/systemd/system/set-cpu-governor.service (КРИТИЧНО!)

**Что делать:**
1. Найди файл `/etc/systemd/system/set-cpu-governor.service`
2. **Удали его полностью** (или переименуй в `.service.bak`)
3. **ВАЖНО:** Этот файл может блокировать загрузку системы!

### Файл 3: Проверить другие проблемные файлы

Проверь эти файлы, если они есть:
- `/etc/security/limits.d/99-audio-pipeline.conf` - можно оставить или удалить
- `/etc/systemd/system/collect-metrics.service` - можно оставить
- `/etc/systemd/system/collect-metrics.timer` - можно оставить

## Шаг 4: Вставить eMMC обратно и проверить

1. Выключи устройство
2. Вставь eMMC обратно
3. Включи устройство
4. Должно загрузиться нормально

## Если не работает

**Полный откат (если ничего не помогло):**
1. Найди файл `/etc/sysctl.conf.backup` (если есть)
2. Скопируй его как `/etc/sysctl.conf` (замени оригинал)
3. Удали все файлы в `/etc/systemd/system/` которые начинаются с:
   - `set-cpu-governor`
   - `collect-metrics` (эти можно оставить, они не должны мешать)

**Если вообще ничего не помогает:**
- Попробуй найти резервную копию всей системы (если делал)
- Или переустанови систему (последний вариант)

## Важно

- **Делай резервные копии** перед изменением файлов
- **Не форматируй диск** - потеряешь все данные
- **Работай аккуратно** - одно неверное движение может сломать систему еще больше

## Анализ опасных изменений

**Наиболее вероятные причины проблемы (в порядке приоритета):**

1. **Параметры ядра для реального времени (90% вероятность блокировки загрузки):**
   - `kernel.sched_rt_runtime_us = 950000` резервирует 95% CPU для реального времени
   - Systemd и другие критичные процессы могут не получить CPU время
   - **КРИТИЧНО:** Удалить эти строки в первую очередь!

2. **Systemd сервис set-cpu-governor.service (80% вероятность блокировки загрузки):**
   - Может зависнуть при выполнении
   - Systemd ждет его завершения и блокирует загрузку
   - **КРИТИЧНО:** Удалить этот файл!

3. **Сетевые параметры (60% вероятность проблем с сетью):**
   - Могут вызвать проблемы с инициализацией сетевых интерфейсов
   - Могут заблокировать загрузку, если система ждет сеть
   - **ВАЖНО:** Удалить эти параметры

**Подробный анализ:** См. `ANALYSIS_DANGEROUS_CHANGES.md`

## Гарантии

**Честно:** На основе анализа, удаление этих изменений должно восстановить систему в 90-95% случаев, потому что:
- Параметры ядра для реального времени - известная причина блокировки загрузки
- Systemd сервис set-cpu-governor - может заблокировать загрузку
- Сетевые параметры - могут вызвать проблемы с сетью

**Если не поможет:**
- Возможно, файловая система повреждена
- Может потребоваться переустановка системы
- Или нужна помощь специалиста с физическим доступом

