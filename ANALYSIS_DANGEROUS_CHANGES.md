# Анализ опасных изменений, приведших к проблемам с загрузкой

## Что было сделано и что могло сломать систему

### 1. Сетевые параметры в sysctl.conf (ВЫСОКИЙ РИСК)

**Что было добавлено:**
```
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.core.netdev_max_backlog = 5000
net.core.rmem_default = 262144
net.core.wmem_default = 262144
```

**Почему это опасно:**
- Эти параметры изменяют размеры буферов сетевого стека
- Слишком большие значения могут вызвать проблемы с памятью
- `net.core.netdev_max_backlog = 5000` может вызвать проблемы на слабых системах
- Неправильные значения могут привести к отказу сетевого стека при загрузке
- **Особенно опасно на ARM системах с ограниченной памятью**

**Известные проблемы:**
- На системах с ограниченной памятью (< 2GB) большие буферы могут вызвать проблемы
- Могут конфликтовать с настройками NetworkManager или systemd-networkd
- Могут вызвать проблемы при инициализации сетевых интерфейсов

### 2. Параметры ядра для реального времени (ВЫСОКИЙ РИСК)

**Что было добавлено:**
```
kernel.sched_rt_runtime_us = 950000
kernel.sched_rt_period_us = 1000000
kernel.sched_migration_cost_ns = 5000000
```

**Почему это опасно:**
- Эти параметры изменяют планировщик задач ядра
- `kernel.sched_rt_runtime_us = 950000` резервирует 95% CPU для реального времени
- Это может заблокировать обычные процессы, включая systemd
- **Может полностью заблокировать загрузку системы**, если systemd не может получить CPU время
- Особенно опасно на системах с одним ядром или слабыми процессорами

**Известные проблемы:**
- Может вызвать "soft lockup" - система зависает
- Может заблокировать systemd и другие критичные сервисы
- На ARM системах может вызвать проблемы с инициализацией

### 3. Systemd сервис set-cpu-governor.service (ВЫСОКИЙ РИСК)

**Что было создано:**
```ini
[Unit]
Description=Set CPU Governor to Performance
After=sysinit.target

[Service]
Type=oneshot
ExecStart=/bin/bash -c 'for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do [ -f "$cpu" ] && echo performance > "$cpu" 2>/dev/null || true; done'
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

**Почему это опасно:**
- Сервис запускается при загрузке (`WantedBy=multi-user.target`)
- Если скрипт зависает или выполняется слишком долго, может заблокировать загрузку
- `After=sysinit.target` может вызвать проблемы с зависимостями
- На некоторых системах изменение CPU governor может вызвать проблемы
- **Может заблокировать загрузку, если systemd ждет завершения этого сервиса**

**Известные проблемы:**
- Systemd может зависнуть, ожидая завершения сервиса
- Если CPU governor не поддерживается, скрипт может зависнуть
- Может вызвать проблемы с зависимостями других сервисов

### 4. vm.swappiness и vm.dirty_ratio (СРЕДНИЙ РИСК)

**Что было добавлено:**
```
vm.swappiness=1
vm.dirty_ratio=10
vm.dirty_background_ratio=5
```

**Почему это может быть опасно:**
- `vm.swappiness=1` - минимум использования swap
- `vm.dirty_ratio=10` - очень агрессивная запись на диск
- На системах с медленным eMMC может вызвать проблемы
- Может вызвать проблемы при загрузке, если система пытается записать много данных

**Известные проблемы:**
- На медленных дисках может замедлить загрузку
- Может вызвать проблемы с инициализацией файловой системы

### 5. Лимиты файловых дескрипторов (НИЗКИЙ РИСК)

**Что было добавлено:**
```
* soft nofile 65536
* hard nofile 65536
```

**Почему это относительно безопасно:**
- Обычно не вызывает проблем с загрузкой
- Может вызвать проблемы только на очень старых системах

## Наиболее вероятные причины проблемы

### Причина 1: Параметры ядра для реального времени (90% вероятность)

**Почему:**
- `kernel.sched_rt_runtime_us = 950000` резервирует 95% CPU для реального времени
- Systemd и другие критичные процессы могут не получить CPU время
- Система зависает при загрузке

**Решение:**
- Удалить эти строки из `/etc/sysctl.conf`

### Причина 2: Systemd сервис set-cpu-governor.service (80% вероятность)

**Почему:**
- Сервис может зависнуть при выполнении
- Systemd ждет его завершения и блокирует загрузку
- Зависимости могут вызвать deadlock

**Решение:**
- Удалить файл `/etc/systemd/system/set-cpu-governor.service`

### Причина 3: Сетевые параметры (60% вероятность)

**Почему:**
- Могут вызвать проблемы с инициализацией сетевых интерфейсов
- NetworkManager или systemd-networkd могут зависнуть
- Может заблокировать загрузку, если система ждет сеть

**Решение:**
- Удалить сетевые параметры из `/etc/sysctl.conf`

## Приоритет исправления

1. **КРИТИЧНО:** Удалить параметры ядра для реального времени
2. **КРИТИЧНО:** Удалить сервис set-cpu-governor.service
3. **ВАЖНО:** Удалить сетевые параметры
4. **ОПЦИОНАЛЬНО:** Вернуть vm.swappiness и vm.dirty_ratio к defaults

## Выводы

**Наиболее вероятная причина:** Комбинация параметров ядра для реального времени (`kernel.sched_rt_runtime_us`) и systemd сервиса `set-cpu-governor.service` заблокировала загрузку системы.

**Почему это произошло:**
- Параметры ядра резервируют 95% CPU для реального времени
- Systemd сервис пытается изменить CPU governor при загрузке
- Systemd не может получить CPU время для выполнения
- Система зависает при загрузке

**Что нужно исправить в первую очередь:**
1. Удалить `kernel.sched_rt_runtime_us`, `kernel.sched_rt_period_us`, `kernel.sched_migration_cost_ns` из sysctl.conf
2. Удалить файл `set-cpu-governor.service`
3. Удалить сетевые параметры из sysctl.conf

