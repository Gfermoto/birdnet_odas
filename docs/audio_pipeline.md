# Аудио пайплайн: ReSpeaker → Log-MMSE → BirdNET-Go

## Обзор

Данный документ описывает полный аудио пайплайн от ReSpeaker USB 4 Mic Array до BirdNET-Go, включая Log-MMSE шумоподавление и ресемплинг.

---

## Архитектура пайплайна

### Полный pipeline

```
┌─────────────┐     ┌──────────────┐     ┌──────────┐     ┌─────────────┐     ┌──────────────┐
│ ReSpeaker   │────▶│ Log-MMSE      │────▶│ SoX       │────▶│ ALSA        │────▶│ BirdNET-Go   │
│ USB Mic     │     │ Processor     │     │ Resample  │     │ Loopback    │     │              │
│             │     │               │     │           │     │             │     │              │
│ 16kHz, 6ch  │     │ 16kHz, 1ch    │     │ 48kHz,1ch │     │ 48kHz, 1ch  │     │ 48kHz, 1ch   │
│ interleaved │     │ mono          │     │ mono      │     │             │     │              │
└─────────────┘     └──────────────┘     └──────────┘     └─────────────┘     └──────────────┘
     │                    │                    │                  │                    │
     │                    │                    │                  │                    │
  arecord            python3              sox              aplay              docker
                     log_mmse_processor   (resample)       (loopback)         birdnet-go
```

### Компоненты

1. **ReSpeaker USB 4 Mic Array**
   - Выход: 16kHz, 6 каналов (interleaved)
   - Канал 0: beamformed (готовый для обработки)
   - Каналы 1-4: raw данные с микрофонов
   - Канал 5: playback (если есть)

2. **Log-MMSE Processor** (`log_mmse_processor.py`)
   - Вход: 16kHz, 6 каналов (interleaved, S16_LE)
   - Выход: 16kHz, 1 канал (моно, S16_LE)
   - Функции: извлечение канала 0, шумоподавление

3. **SoX Resampler**
   - Вход: 16kHz, 1 канал (S16_LE)
   - Выход: 48kHz, 1 канал (S16_LE)
   - Функция: качественный ресемплинг для BirdNET-Go

4. **ALSA Loopback**
   - Device 1 (playback): запись от SoX
   - Device 0 (capture): чтение BirdNET-Go
   - Функция: виртуальное устройство для связи

5. **BirdNET-Go**
   - Вход: 48kHz, 1 канал (S16_LE)
   - Функция: распознавание птиц

---

## Реализация пайплайна

### Скрипт `respeaker_loopback.sh`

```bash
#!/bin/bash
# Скрипт для передачи ReSpeaker через Log-MMSE и SoX в ALSA loopback
while true; do
    arecord -D hw:ArrayUAC10,0 -f S16_LE -r 16000 -c 6 -t raw 2>/dev/null | \
    python3 /usr/local/bin/log_mmse_processor.py | \
    sox -t raw -r 16000 -c 1 -e signed-integer -b 16 -L - \
        -t raw -r 48000 -c 1 -e signed-integer -b 16 -L - gain -2.0 | \
    aplay -D hw:2,1,0 -f S16_LE -r 48000 -c 1 -t raw 2>/dev/null || sleep 1
done
```

### Команды по этапам

1. **Запись с ReSpeaker:**
   ```bash
   arecord -D hw:ArrayUAC10,0 -f S16_LE -r 16000 -c 6 -t raw
   ```
   - `hw:ArrayUAC10,0` - прямое подключение к ReSpeaker
   - `-f S16_LE` - signed 16-bit little-endian
   - `-r 16000` - частота дискретизации 16kHz
   - `-c 6` - 6 каналов
   - `-t raw` - raw формат (без заголовка)

2. **Log-MMSE обработка:**
   ```bash
   python3 /usr/local/bin/log_mmse_processor.py
   ```
   - Читает из stdin: 16kHz, 6ch, S16_LE
   - Выдает в stdout: 16kHz, 1ch, S16_LE

3. **Ресемплинг SoX:**
   ```bash
   sox -t raw -r 16000 -c 1 -e signed-integer -b 16 -L - \
       -t raw -r 48000 -c 1 -e signed-integer -b 16 -L - gain -2.0
   ```
   - Вход: 16kHz, 1ch, S16_LE
   - Выход: 48kHz, 1ch, S16_LE
   - Качественный ресемплинг (лучше чем ALSA plug)
   - `gain -2.0` - снижение уровня на 2 дБ для предотвращения clipping при сильном ветре

4. **Запись в ALSA Loopback:**
   ```bash
   aplay -D hw:2,1,0 -f S16_LE -r 48000 -c 1 -t raw
   ```
   - `hw:2,1,0` - loopback card 2, device 1 (playback), subdevice 0
   - Записывает в виртуальное устройство

5. **Чтение BirdNET-Go:**
   - Читает из `hw:2,0,0` (loopback card 2, device 0, capture)
   - Автоматически выбирается после перезагрузки

---

## Log-MMSE алгоритм шумоподавления

### Обзор

Log-MMSE (Minimum Mean-Square Error Log-Spectral Amplitude Estimator) - алгоритм шумоподавления, разработанный Ephraim & Malah (1985). Оптимизирован для нестационарного шума (ветер, дождь) и сохранения слабых сигналов (пение птиц).

### Математические основы

#### 1. STFT анализ

Преобразование сигнала в частотную область:

```
Y(ω,t) = FFT[x(t) × w(t)]
```

где:
- `x(t)` - входной сигнал (канал 0)
- `w(t)` - Hann window
- `Y(ω,t)` - комплексный спектр

**Параметры:**
- Frame size: 1024 samples (лучшее частотное разрешение для птиц)
- Hop size: 512 samples (50% overlap)
- Window: Hann window

#### 2. Оценка шума

Power Spectral Density (PSD) шума оценивается адаптивно:

```
λ(ω) = mean(|Y(ω,t)|²) для t ∈ [0, NOISE_FRAMES]
```

**Адаптивное обновление (первые 2×NOISE_FRAMES):**
```
λ(ω,t) = 0.98 × λ(ω,t-1) + 0.02 × |Y(ω,t)|²
```

#### 3. A Posteriori SNR

Отношение сигнал/шум после наблюдения:

```
γ(ω,t) = |Y(ω,t)|² / λ(ω)
```

#### 4. A Priori SNR (Decision-Directed)

Оценка отношения сигнал/шум до наблюдения:

```
ξ(ω,t) = α × G²(ω,t-1) × γ(ω,t-1) + (1-α) × max(γ(ω,t) - 1, 0)
```

где:
- `α = 0.50` - smoothing factor (текущая настройка: минимальное сглаживание, очень быстрая адаптация)
- `G(ω,t-1)` - gain из предыдущего frame
- `γ(ω,t-1)` - a posteriori SNR предыдущего frame

#### 5. Log-MMSE Gain

Вычисление gain mask:

```
G(ω) = (ξ / (1+ξ)) × exp(0.5 × E₁(ν))
```

где:
- `ν = (ξ / (1+ξ)) × γ`
- `E₁(ν)` - exponential integral первого порядка

#### 6. Применение gain

```
S_enhanced(ω,t) = G(ω) × Y(ω,t)
```

#### 7. ISTFT и Overlap-Add

Восстановление сигнала во временной области:

```
s_enhanced(t) = IFFT[S_enhanced(ω,t)]
s_windowed(t) = s_enhanced(t) × w(t)
```

Overlap-add с нормализацией:
```
output(t) = Σ s_windowed(t) / norm(t)
```

где `norm(t)` учитывает overlap window².

#### 8. Защита от Clipping

Перед преобразованием в int16 применяется мягкое ограничение (soft limiter):
```
output_limited(t) = tanh(output(t) × 0.90)
```

- **tanh()** обеспечивает плавное ограничение без резких артефактов
- **Коэффициент 0.90** создает запас 10% для предотвращения перегрузок при сильном ветре
- В сочетании с `gain -2.0` в SoX обеспечивает двойную защиту от clipping

### Параметры алгоритма

| Параметр | Значение | Обоснование |
|----------|---------|-------------|
| `FRAME_SIZE` | 1024 | Лучшее частотное разрешение для птиц (1-8 kHz) |
| `HOP_SIZE` | 512 | 50% overlap для плавного восстановления |
| `ALPHA` | 0.50 | Минимальное сглаживание: подавление шума ~30-40%, очень быстрая адаптация, максимальное сохранение сигналов |
| `NOISE_FRAMES` | 10 | Быстрая оценка шума и адаптация к изменениям |
| Частота обработки | 16kHz | Меньше данных, быстрее обработка |

### Преимущества Log-MMSE

1. **Подавление нестационарного шума**
   - Ветер (низкочастотный, нестационарный)
   - Дождь (широкополосный)
   - Фоновые звуки

2. **Подавление стационарного шума**
   - ЛЭП (50/60 Гц и гармоники) - эффективно подавляется
   - Низкочастотный гул от высоковольтных линий
   - Постоянные фоновые шумы

3. **Сохранение слабых сигналов**
   - Пение птиц (1-8 kHz)
   - Слабые компоненты не подавляются

4. **Низкий musical noise**
   - Лучше чем Spectral Subtraction
   - Плавное восстановление сигнала

5. **Оптимизация для птиц**
   - Обработка на 16kHz (меньше данных)
   - Frame size 1024 (лучшее разрешение)
   - Alpha 0.95 (для нестационарного шума)

### Эффективность против ЛЭП

Log-MMSE особенно эффективен для подавления стационарного шума от высоковольтных линий электропередачи:

- **HPF на 180 Гц** (микрофон) подавляет 50/60 Гц и первые гармоники
- **HPF на 300 Гц** (BirdNET-Go) дополнительно подавляет гармоники до 300 Гц
- **Log-MMSE** эффективно обрабатывает стационарный шум (50 Гц, 100 Гц, 150 Гц...)
- **Адаптивная оценка шума** позволяет алгоритму "выучить" характерный шум ЛЭП

**Типичный сценарий:** Ветер + ЛЭП - идеальные условия для тестирования Log-MMSE, так как оба источника шума эффективно подавляются алгоритмом.

---

## Ресемплинг SoX

### Зачем нужен ресемплинг

BirdNET-Go требует входной сигнал на 48kHz, а ReSpeaker выдает 16kHz. Ресемплинг выполняется через SoX для обеспечения высокого качества.

### Параметры ресемплинга

```bash
sox -t raw -r 16000 -c 1 -e signed-integer -b 16 -L - \
    -t raw -r 48000 -c 1 -e signed-integer -b 16 -L - gain -2.0
```

- **Вход:** 16kHz, 1 канал, S16_LE
- **Выход:** 48kHz, 1 канал, S16_LE
- **Алгоритм:** Высококачественный ресемплинг SoX (лучше чем ALSA plug)
- **Защита от clipping:** `gain -2.0` снижает уровень на 2 дБ для предотвращения перегрузок при сильном ветре

### Почему SoX, а не ALSA plug

- ✅ Лучшее качество ресемплинга
- ✅ Явный контроль параметров
- ✅ Меньше артефактов
- ✅ Оптимизирован для аудио обработки

---

## ALSA Loopback устройство

### Назначение

ALSA Loopback создает виртуальное аудио устройство для связи между скриптом обработки и BirdNET-Go.

### Структура устройства

```
Loopback Card 2 (index=2)
├── Device 0 (capture)  ← BirdNET-Go читает отсюда
└── Device 1 (playback) ← Скрипт пишет сюда
```

### Настройка

```bash
# Загрузка модуля
modprobe snd-aloop

# Автозагрузка
echo "snd-aloop" > /etc/modules-load.d/snd-aloop.conf

# Переименование для идентификации
echo "options snd-aloop id=ACapture index=2" > /etc/modprobe.d/snd-aloop.conf
```

### Использование в BirdNET-Go

В Web GUI выбирается устройство:
- **Третье устройство в списке** - `Loopback, Loopback PCM` (`:2,0`)
- Это device 0 (capture), из которого BirdNET-Go читает данные

**Важно:** После перезагрузки BirdNET-Go автоматически выбирает правильное устройство (`:2,0`).

---

## Производительность

### Латентность

- **Log-MMSE обработка:** ~30-50 мс (зависит от FRAME_SIZE)
- **Ресемплинг SoX:** ~10-20 мс
- **Общая латентность:** ~40-70 мс

### CPU нагрузка

- **Log-MMSE:** Умеренная (FFT/IFFT на 1024 точек)
- **SoX:** Низкая (качественный ресемплинг)
- **Общая нагрузка:** Приемлема для NanoPi M4B

### Память

- **Буферы фиксированного размера:**
  - Input buffer: ~6 KB (HOP_SIZE × 6 × 2 bytes)
  - Output buffer: ~4 KB (FRAME_SIZE × 4 bytes)
  - STFT буферы: ~8 KB
  - **Общая память:** < 20 KB

---

## Устранение неполадок

### Проблема: Нет звука в BirdNET-Go

**Проверка:**
```bash
# Проверка занятых устройств
/usr/local/bin/check_audio_devices.sh

# Проверка процесса
ps aux | grep log_mmse_processor
ps aux | grep sox
ps aux | grep aplay
```

**Решение:**
- Убедитесь, что выбран правильный loopback device (`:2,0` - третье в списке)
- Проверьте логи: `journalctl -u respeaker-loopback.service`

### Проблема: Артефакты в звуке (искажения при сильном ветре)

**Возможные причины:**
- Clipping (перегрузка) при сильном сигнале
- Неправильная нормализация overlap-add
- Проблемы с ресемплингом
- Перегрузка CPU

**Решение:**
- ✅ **Защита от clipping уже реализована:**
  - Мягкое ограничение (soft limiter) в Log-MMSE: `tanh(output * 0.90)`
  - Снижение уровня в SoX: `gain -2.0`
- Проверьте параметры STFT (FRAME_SIZE, HOP_SIZE)
- Убедитесь, что используется правильная нормализация
- Мониторинг CPU: `top` или `htop`
- Если искажения сохраняются, можно увеличить запас:
  - В `log_mmse_processor.py`: уменьшить коэффициент (0.90 → 0.85)
  - В `respeaker_loopback.sh`: увеличить снижение уровня (gain -2.0 → -2.5)

### Проблема: Эффект "то тишина, то прорывается" (слишком агрессивное подавление)

**Симптомы:**
- Постоянный равномерный шум превращается в "то полная тишина, то прорывается ветер"
- Слишком агрессивное подавление создает артефакты

**Решение:**
- ✅ **Текущие настройки оптимизированы:**
  - `ALPHA = 0.85` - мягкое подавление ~2x без артефактов
  - `NOISE_FRAMES = 12` - баланс между оценкой и адаптивностью
- Если эффект сохраняется, можно еще уменьшить `ALPHA` до 0.82-0.84
- Цель: равномерное снижение шума в 2 раза без эффекта "включения/выключения"

### Проблема: Фоновые шумы в записи

**Возможные причины:**
- Недостаточное подавление шума в Log-MMSE
- Неправильная оценка шума (слишком короткий период обучения)
- Стационарные шумы (ЛЭП, вентиляторы) требуют дополнительной фильтрации

**Решение:**
- Текущие настройки (`ALPHA = 0.85`, `NOISE_FRAMES = 12`) обеспечивают снижение шума ~2x
- Убедитесь, что первые секунды записи содержат только фоновый шум (для обучения алгоритма)
- Для стационарных шумов (ЛЭП) используйте HPF на микрофоне (см. [respeaker_usb4mic_setup.md](respeaker_usb4mic_setup.md))
- Если нужно большее подавление, можно увеличить `ALPHA` до 0.94-0.95 (но может появиться эффект "то тишина, то прорывается")

### Проблема: Слабые сигналы птиц подавляются

**Возможные причины:**
- Слишком агрессивное шумоподавление
- Неправильная оценка SNR

**Решение:**
- Уменьшите `ALPHA` до 0.92-0.93 для более мягкого подавления (сохраняет слабые сигналы)
- Убедитесь, что `NOISE_FRAMES` не слишком велико (10-15 frames оптимально)
- Проверьте, что входной сигнал не слишком тихий (уровень записи с ReSpeaker)

---

## Оптимизация для качества записи

### Текущие настройки

Оптимизированы для максимального качества записи птиц без фоновых шумов и искажений:

- **FRAME_SIZE = 1024** - оптимальное частотное разрешение для птиц (1-8 kHz)
- **HOP_SIZE = 512** - 50% overlap для плавного восстановления без артефактов
- **ALPHA = 0.50** - минимальное сглаживание: подавление шума ~30-40%, очень быстрая адаптация, максимальное сохранение сигналов
- **NOISE_FRAMES = 10** - быстрая оценка шума и адаптация к изменениям
- **Обработка на 16kHz** - оптимально для птиц (основной диапазон 1-8 kHz)
- **Защита от clipping:**
  - Мягкое ограничение: `tanh(output × 0.90)` в Log-MMSE
  - Снижение уровня: `gain -2.0` в SoX
  - Обеспечивает чистый звук без искажений при сильном ветре

### Настройка для максимального качества

Если процессор позволяет (загрузка < 70%), можно улучшить качество:

1. **Улучшение частотного разрешения:**
   - Увеличить `FRAME_SIZE` до 2048 (лучше разрешение, но выше задержка)
   - Увеличить `HOP_SIZE` до 1024 (сохранить 50% overlap)

2. **Улучшение подавления шума:**
   - ✅ `NOISE_FRAMES = 12` - баланс между оценкой и адаптивностью
   - ✅ `ALPHA = 0.85` - мягкое подавление ~2x без артефактов (оптимально для записи птиц)

3. **Сохранение слабых сигналов:**
   - Уменьшить `ALPHA` до 0.92-0.93 если слабые сигналы птиц подавляются

### Возможные улучшения

1. **Использование numba:**
   ```python
   from numba import jit
   @jit(nopython=True)
   def log_mmse_gain(xi, gamma):
       # ...
   ```

2. **Оптимизация памяти:**
   - Pre-allocated буферы
   - Избежание копий (views вместо copies)

3. **Параллелизация:**
   - Обработка нескольких frames параллельно
   - Использование multiprocessing

---

## Ссылки

- Ephraim, Y., & Malah, D. (1985). "Speech Enhancement Using a Minimum Mean-Square Error Log-Spectral Amplitude Estimator". IEEE Transactions on Acoustics, Speech, and Signal Processing, 33(2), 443-445.
- SoX - Sound eXchange: http://sox.sourceforge.net/
- ALSA Loopback: https://www.alsa-project.org/wiki/Matrix:Module-aloop
- BirdNET-Go: https://github.com/tphakala/birdnet-go

---

## Связанные документы

- [respeaker_usb4mic_setup.md](respeaker_usb4mic_setup.md) - Настройка ReSpeaker USB Mic Array
- [birdnet_go_setup.md](birdnet_go_setup.md) - Установка и настройка BirdNET-Go

